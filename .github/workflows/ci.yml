name: NBA Injury Report Validation Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Detect missing static assets
        id: assets_check
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          team_codes = {
              "atl", "bkn", "bos", "cha", "chi", "cle", "dal", "den", "det", "gs",
              "hou", "ind", "lac", "lal", "mem", "mia", "mil", "min", "no", "ny",
              "okc", "orl", "phi", "phx", "por", "sa", "sac", "tor", "utah", "wsh",
          }
          logo_dir = Path("assets/team_logos")
          headshot_dir = Path("assets/player_headshots")
          map_path = headshot_dir / "player_name_map.json"

          missing_logos = [code for code in sorted(team_codes) if not (logo_dir / f"{code}.png").exists()]
          headshot_count = len(list(headshot_dir.glob("*.png")))
          map_exists = map_path.exists()
          missing = bool(missing_logos) or (headshot_count < 400) or (not map_exists)

          print(f"Missing logos: {missing_logos}")
          print(f"Headshot count: {headshot_count}")
          print(f"Map exists: {map_exists}")
          print(f"Missing assets detected: {missing}")

          output_path = os.environ.get("GITHUB_OUTPUT")
          if output_path:
            with open(output_path, "a", encoding="utf-8") as output:
              output.write(f"missing={'1' if missing else '0'}\n")
          PY

      - name: Regenerate missing assets
        if: steps.assets_check.outputs.missing == '1'
        run: |
          python scripts/assets/sync_nba_assets.py --only logos --force-logos
          python scripts/assets/sync_nba_assets.py --only players --players-source active-and-reports --max-workers 12

      - name: Verify static assets
        run: |
          python - <<'PY'
          from pathlib import Path

          team_codes = {
              "atl", "bkn", "bos", "cha", "chi", "cle", "dal", "den", "det", "gs",
              "hou", "ind", "lac", "lal", "mem", "mia", "mil", "min", "no", "ny",
              "okc", "orl", "phi", "phx", "por", "sa", "sac", "tor", "utah", "wsh",
          }
          logo_dir = Path("assets/team_logos")
          headshot_dir = Path("assets/player_headshots")
          map_path = headshot_dir / "player_name_map.json"

          missing_logos = [code for code in sorted(team_codes) if not (logo_dir / f"{code}.png").exists()]
          headshot_count = len(list(headshot_dir.glob("*.png")))
          if missing_logos:
            raise SystemExit(f"Missing team logos after sync: {missing_logos}")
          if not map_path.exists():
            raise SystemExit("Missing player_name_map.json after sync")
          if headshot_count < 400:
            raise SystemExit(f"Headshot count too low after sync: {headshot_count}")
          print(f"Asset verification passed. Logos={len(team_codes)} Headshots={headshot_count}")
          PY

      - name: Compile checks
        run: |
          python -m py_compile app.py injury_report_dashboard.py validate_injury_report_csv.py scripts/assets/sync_player_headshots.py scripts/assets/sync_nba_assets.py

      - name: Unit tests
        run: |
          python -m unittest discover -s tests -p 'test_*.py'

      - name: Validate sample/latest CSV when available
        run: |
          shopt -s nullglob
          files=(data/Injury-Report_*.csv)
          if [ ${#files[@]} -gt 0 ]; then
            python validate_injury_report_csv.py --data-dir data
          else
            echo "No Injury-Report_*.csv found in data/, skipping validator run."
          fi
